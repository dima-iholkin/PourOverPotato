var q=Object.defineProperty;var X=(t,e,s)=>e in t?q(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var n=(t,e,s)=>(X(t,typeof e!="symbol"?e+"":e,s),s);class D{constructor(e){n(this,"id");n(this,"name");n(this,"description");this.id=e.id,this.name=e.name,this.description=e.description}static hasValidName(e){return e.name.trim().length<3?"ValidationFailed_NameMustBeAtLeast3CharsLong":!0}}class M{constructor(e){n(this,"name");n(this,"description");this.name=e.name,this.description=e.description}static create(e){if(D.hasValidName(e)==="ValidationFailed_NameMustBeAtLeast3CharsLong")return"ValidationFailed_NameMustBeAtLeast3CharsLong";const s=e.name.trim(),o=e.description.trim(),i={name:s,description:o};return new M(i)}}class x{constructor(e){n(this,"id");n(this,"name");n(this,"description");this.id=e.id,this.name=e.name,this.description=e.description}static create(e){if(D.hasValidName(e)==="ValidationFailed_NameMustBeAtLeast3CharsLong")return"ValidationFailed_NameMustBeAtLeast3CharsLong";const s=e.name.trim(),o=e.description.trim(),i={id:e.id,name:s,description:o};return new x(i)}}const E=(t,e)=>e.some(s=>t instanceof s);let V,L;function K(){return V||(V=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function $(){return L||(L=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const R=new WeakMap,I=new WeakMap,C=new WeakMap;function H(t){const e=new Promise((s,o)=>{const i=()=>{t.removeEventListener("success",a),t.removeEventListener("error",r)},a=()=>{s(p(t.result)),i()},r=()=>{o(t.error),i()};t.addEventListener("success",a),t.addEventListener("error",r)});return C.set(e,t),e}function U(t){if(R.has(t))return;const e=new Promise((s,o)=>{const i=()=>{t.removeEventListener("complete",a),t.removeEventListener("error",r),t.removeEventListener("abort",r)},a=()=>{s(),i()},r=()=>{o(t.error||new DOMException("AbortError","AbortError")),i()};t.addEventListener("complete",a),t.addEventListener("error",r),t.addEventListener("abort",r)});R.set(t,e)}let j={get(t,e,s){if(t instanceof IDBTransaction){if(e==="done")return R.get(t);if(e==="store")return s.objectStoreNames[1]?void 0:s.objectStore(s.objectStoreNames[0])}return p(t[e])},set(t,e,s){return t[e]=s,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function F(t){j=t(j)}function z(t){return $().includes(t)?function(...e){return t.apply(v(this),e),p(this.request)}:function(...e){return p(t.apply(v(this),e))}}function G(t){return typeof t=="function"?z(t):(t instanceof IDBTransaction&&U(t),E(t,K())?new Proxy(t,j):t)}function p(t){if(t instanceof IDBRequest)return H(t);if(I.has(t))return I.get(t);const e=G(t);return e!==t&&(I.set(t,e),C.set(e,t)),e}const v=t=>C.get(t);function J(t,e,{blocked:s,upgrade:o,blocking:i,terminated:a}={}){const r=indexedDB.open(t,e),u=p(r);return o&&r.addEventListener("upgradeneeded",c=>{o(p(r.result),c.oldVersion,c.newVersion,p(r.transaction),c)}),s&&r.addEventListener("blocked",c=>s(c.oldVersion,c.newVersion,c)),u.then(c=>{a&&c.addEventListener("close",()=>a()),i&&c.addEventListener("versionchange",d=>i(d.oldVersion,d.newVersion,d))}).catch(()=>{}),u}function Be(t,{blocked:e}={}){const s=indexedDB.deleteDatabase(t);return e&&s.addEventListener("blocked",o=>e(o.oldVersion,o)),p(s).then(()=>{})}const Q=["get","getKey","getAll","getAllKeys","count"],Y=["put","add","delete","clear"],S=new Map;function N(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(S.get(e))return S.get(e);const s=e.replace(/FromIndex$/,""),o=e!==s,i=Y.includes(s);if(!(s in(o?IDBIndex:IDBObjectStore).prototype)||!(i||Q.includes(s)))return;const a=async function(r,...u){const c=this.transaction(r,i?"readwrite":"readonly");let d=c.store;return o&&(d=d.index(u.shift())),(await Promise.all([d[s](...u),i&&c.done]))[0]};return S.set(e,a),a}F(t=>({...t,get:(e,s,o)=>N(e,s)||t.get(e,s,o),has:(e,s)=>!!N(e,s)||t.has(e,s)}));const Z=["continue","continuePrimaryKey","advance"],W={},y=new WeakMap,A=new WeakMap,ee={get(t,e){if(!Z.includes(e))return t[e];let s=W[e];return s||(s=W[e]=function(...o){y.set(this,A.get(this)[e](...o))}),s}};async function*te(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;const s=new Proxy(e,ee);for(A.set(s,e),C.set(s,v(e));e;)yield s,e=await(y.get(s)||e.continue()),y.delete(s)}function O(t,e){return e===Symbol.asyncIterator&&E(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&E(t,[IDBIndex,IDBObjectStore])}F(t=>({...t,get(e,s,o){return O(e,s)?te:t.get(e,s,o)},has(e,s){return O(e,s)||t.has(e,s)}}));function De(t,e){return t.favorite===e.favorite?se(t,e):t.favorite===!0?-1:e.favorite===!0?1:0}function Ce(t,e){return t.outWeight===e.outWeight?b(t,e):t.outWeight-e.outWeight}function Ie(t,e){return t.outWeight===e.outWeight?b(t,e):e.outWeight-t.outWeight}function Se(t,e){return t.rating===e.rating?b(t,e):t.rating-e.rating}function se(t,e){return t.rating===e.rating?b(t,e):e.rating-t.rating}function Ee(t,e){return t.timestamp.getTime()-e.timestamp.getTime()}function b(t,e){return e.timestamp.getTime()-t.timestamp.getTime()}class g{constructor(e){n(this,"id");n(this,"name");n(this,"nameLowerCase");n(this,"description");n(this,"softDeletionTimestamp");this.id=e.id,this.name=e.name,this.nameLowerCase=e.nameLowerCase,this.description=e.description,this.softDeletionTimestamp=e.softDeletionTimestamp}static fromCoffeeBeans(e){const s={...e,nameLowerCase:e.name.toLowerCase(),softDeletionTimestamp:void 0};return new g(s)}toCoffeeBeans(){return new D(this)}}class Re{constructor(e){n(this,"name");n(this,"nameLowerCase");n(this,"description");n(this,"softDeletionTimestamp");this.name=e.name,this.nameLowerCase=e.name.toLowerCase(),this.description=e.description,this.softDeletionTimestamp=void 0}}class ne extends D{constructor(s,o){super(s);n(this,"recipeCount");n(this,"latestRecipeTimestamp");n(this,"earliestRecipeTimestamp");this.recipeCount=o.recipeCount,this.latestRecipeTimestamp=o.latestRecipeTimestamp,this.earliestRecipeTimestamp=o.earliestRecipeTimestamp}}function oe(t,e){const s={recipeCount:e.recipesCount,latestRecipeTimestamp:e.latestRecipeTimestamp?new Date(e.latestRecipeTimestamp):void 0,earliestRecipeTimestamp:e.earliestRecipeTimestamp?new Date(e.earliestRecipeTimestamp):void 0};return new ne(t,s)}class ie{constructor(e){n(this,"id");n(this,"coffeeBeansId");n(this,"recipeTarget");n(this,"recipeResult");n(this,"recipeThoughts");n(this,"favorite");n(this,"rating");n(this,"outWeight");n(this,"timestamp");this.id=e.id,this.coffeeBeansId=e.coffeeBeansId,this.recipeTarget=e.recipeTarget,this.recipeResult=e.recipeResult,this.recipeThoughts=e.recipeThoughts,this.favorite=e.favorite,this.rating=e.rating,this.outWeight=e.outWeight,this.timestamp=e.timestamp}}class je{constructor(e){n(this,"coffeeBeansId");n(this,"recipeTarget");n(this,"recipeResult");n(this,"recipeThoughts");n(this,"favorite");n(this,"rating");n(this,"outWeight");n(this,"timestamp");this.coffeeBeansId=e.coffeeBeansId,this.recipeTarget=e.recipeTarget,this.recipeResult=e.recipeResult,this.recipeThoughts=e.recipeThoughts,this.favorite=e.favorite,this.rating=e.rating,this.outWeight=e.outWeight,this.timestamp=e.timestamp}}class w{constructor(e){n(this,"id");n(this,"coffeeBeansId");n(this,"recipeTarget");n(this,"recipeResult");n(this,"recipeThoughts");n(this,"favorite");n(this,"rating");n(this,"outWeight");n(this,"timestamp");n(this,"softDeletionTimestamp");this.id=e.id,this.coffeeBeansId=e.coffeeBeansId,this.recipeTarget=e.recipeTarget,this.recipeResult=e.recipeResult,this.recipeThoughts=e.recipeThoughts,this.favorite=e.favorite??!1,this.rating=e.rating,this.outWeight=e.outWeight,this.timestamp=e.timestamp,this.softDeletionTimestamp=e.softDeletionTimestamp}static fromRecipe(e){const s={...e,timestamp:e.timestamp.getTime(),softDeletionTimestamp:void 0};return new w(s)}toRecipe(){const e={...this,favorite:this.favorite??!1,timestamp:new Date(this.timestamp)};return new ie(e)}}class ve{constructor(e){n(this,"coffeeBeansId");n(this,"recipeTarget");n(this,"recipeResult");n(this,"recipeThoughts");n(this,"favorite");n(this,"rating");n(this,"outWeight");n(this,"timestamp");n(this,"softDeletionTimestamp");this.coffeeBeansId=e.coffeeBeansId,this.recipeTarget=e.recipeTarget,this.recipeResult=e.recipeResult,this.recipeThoughts=e.recipeThoughts,this.favorite=e.favorite??!1,this.rating=e.rating,this.outWeight=e.outWeight,this.timestamp=e.timestamp.getTime(),this.softDeletionTimestamp=void 0}toRecipeDB(e,s){return new w({...e,id:s})}}async function ye(){const e=(await le()).transaction([f,h],"readonly"),o=(await e.objectStore(f).getAll()).filter(a=>a.softDeletionTimestamp===void 0).map(a=>new g(a).toCoffeeBeans()),i=[];for(const a of o){const r=await e.objectStore(h).get(a.id),u={recipesCount:(r==null?void 0:r.recipesCount)??0,latestRecipeTimestamp:r==null?void 0:r.latestRecipeTimestamp,earliestRecipeTimestamp:r==null?void 0:r.earliestRecipeTimestamp},c=oe(a,u);i.push(c)}return await e.done,i}async function ae(t,e){var a,r;let s=await e.objectStore(h).get(t);const i=(await e.objectStore(m).index(P).getAll(t)).filter(u=>u.softDeletionTimestamp===void 0).map(u=>new w(u).toRecipe()).toSorted(b);s={id:t,recipesCount:i.length,latestRecipeTimestamp:(a=i[0])==null?void 0:a.timestamp.getTime(),earliestRecipeTimestamp:(r=i.at(-1))==null?void 0:r.timestamp.getTime()},await e.objectStore(h).put(s)}async function re(t){if(t.db.objectStoreNames.contains(h)===!1)throw new Error(`Object store ${h} wasn't found.`);await t.objectStore(h).clear();const e=await t.objectStore(f).getAll();for(const s of e)await ae(s.id,t)}function _(t){const e=new CustomEvent("addToast",{detail:{message:t,timeout:5e3}});document.dispatchEvent(e)}function Ve(t,e,s){const o=new CustomEvent("addToast",{detail:{message:t,timeout:1e4,onClickUndo:e,onUndoIgnored:s}});document.dispatchEvent(o)}async function ce(t){if(t.db.objectStoreNames.contains(f)===!1)return;const e=await t.objectStore(f).getAll(),s=t;for(const o of e){const i={...o,softDeletionTimestamp:void 0},a=new g(i);await s.objectStore(f).put(a)}}async function fe(t){if(t.db.objectStoreNames.contains(f)===!1)return;const e=await t.objectStore(f).getAll(),s=t;for(const o of e){const i={...o,softDeletionTimestamp:o.softDeleted?Date.now():void 0},a=new g(i);await s.objectStore(f).put(a)}}async function ue(t){if(t.db.objectStoreNames.contains(f)===!1)return;t.objectStore(f).indexNames.contains(l)&&t.objectStore(f).deleteIndex(l);const e=await t.objectStore(f).getAll(),s=new Map;e.forEach(i=>{const a=s.get(i.nameLowerCase);a===void 0?s.set(i.nameLowerCase,1):s.set(i.nameLowerCase,a+1)});for await(const[i,a]of s){if(a<2)continue;let r=e.filter(c=>c.nameLowerCase.startsWith(i+"-")).map(c=>c.nameLowerCase.slice(i.length+1)).map(c=>Number(c)).filter(c=>Number.isInteger(c)).sort().at(-1);if(r===void 0||isNaN(r))throw _("Something went wrong with coffee beans deduplication during migration. Please contact the developer."),new Error("Something went wrong with greatestNum value.");const u=e.filter(c=>c.nameLowerCase===i);for await(const c of u){r++;const d=c.name+"-"+r,k=new g({...c,name:d,nameLowerCase:d.toLowerCase(),softDeletionTimestamp:void 0});await t.objectStore(f).put(k)}}t.objectStore(f).createIndex(l,l,{unique:!0});let o=!1;s.forEach(i=>{i>=2&&o===!1&&(o=!0,_("Coffee beans with duplicate names were renamed to make them unique."))})}async function me(t){if(t.db.objectStoreNames.contains(m)===!1)return;const e=await t.objectStore(m).getAll(),s=t;for(const o of e){const i={...o,favorite:!1,timestamp:o.timestamp.getTime(),softDeletionTimestamp:void 0},a=new w(i);await s.objectStore(m).put(a)}}async function de(t){if(t.db.objectStoreNames.contains(m)===!1)return;const e=await t.objectStore(m).getAll(),s=t;for(const o of e){const i={...o,favorite:o.favorite??!1,softDeletionTimestamp:o.softDeleted?Date.now():void 0},a=new w(i);await s.objectStore(m).put(a)}}const he=4,pe="entities",f="coffeeBeans",m="recipes",h="enhancedCoffeeBeans",l="nameLowerCase",P="coffeeBeansId",B="softDeletionTimestamp";async function le(){return await J(pe,he,{async upgrade(t,e,s,o){switch(e){case 0:break;case 1:{const i=o;await ce(i),await me(i);break}case 2:{const i=o;await fe(i),await de(i);break}case 3:{await ue(o);break}}ge(o),await re(o)}})}function ge(t){const e=t.db;e.objectStoreNames.contains(f)===!1&&e.createObjectStore(f,{keyPath:"id",autoIncrement:!0}),we(t),Te(t),e.objectStoreNames.contains(m)===!1&&e.createObjectStore(m,{keyPath:"id",autoIncrement:!0}),T(t,P),T(t,"outWeight"),T(t,"rating"),T(t,"timestamp"),T(t,B),e.objectStoreNames.contains(h)===!1&&e.createObjectStore(h,{keyPath:"id"})}function we(t){t.objectStore(f).indexNames.contains(l)||t.objectStore(f).createIndex(l,l,{unique:!0})}function Te(t){t.objectStore(f).indexNames.contains(B)||t.objectStore(f).createIndex(B,B,{unique:!1})}function T(t,e){t.objectStore(m).indexNames.contains(e)||t.objectStore(m).createIndex(e,e,{unique:!1})}export{f as C,pe as D,h as E,m as R,B as S,_ as a,g as b,l as c,P as d,D as e,Re as f,ie as g,Ve as h,ve as i,w as j,M as k,je as l,Be as m,re as n,le as o,x as p,Ee as q,ae as r,b as s,De as t,se as u,Se as v,Ie as w,Ce as x,ye as y};
